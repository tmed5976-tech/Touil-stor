import React, { useState, createContext, useContext, useEffect } from 'react';
import { ShoppingCart, Heart, Search, ChevronLeft, Trash2, LogIn, LogOut, UserPlus, User, X, Package } from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from 'firebase/auth';
import { getFirestore, doc, setDoc, onSnapshot, collection, query, where, addDoc, serverTimestamp } from 'firebase/firestore';

// ثابت يمكنك التحكم به لزيادة أو تقليل عدد المنتجات في المتجر
const PRODUCT_COUNT = 40;

// دالة لإنشاء منتجات وهمية بشكل تلقائي
const generateDummyProducts = (count) => {
  const names = ['فستان سهرة أنيق', 'قميص رجالي قطني', 'جاكيت جينز عصري', 'تنورة ميدي صوف'];
  const descriptions = [
    'منتج عصري بتصميم حديث، مثالي للمناسبات الخاصة والحفلات. مصنوع من قماش فاخر مع تفاصيل دقيقة.',
    'منتج كلاسيكي مصنوع من القطن الناعم، يوفر الراحة والأناقة في آن واحد.',
    'منتج بتصميم عصري يناسب الإطلالات اليومية. مصنوع من الدنيم عالي الجودة لمتانة تدوم طويلاً.',
    'منتج دافئ ومريح، مثالي لفصل الشتاء. يمكن تنسيقه بسهولة مع العديد من القطع العلوية.'
  ];
  const images = [
    'https://images.unsplash.com/photo-1543265886-c43093c8d197?ixlib=rb-4.0.3&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=1080&fit=max',
    'https://images.unsplash.com/photo-1598460670355-0814407b1a03?ixlib=rb-4.0.3&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=1080&fit=max',
    'https://images.unsplash.com/photo-1591047120610-c117e3f815e1?ixlib=rb-4.0.3&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=1080&fit=max',
    'https://images.unsplash.com/photo-1631548694086-4e5b22b821a3?ixlib=rb-4.0.3&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=1080&fit=max'
  ];
  const colors = ['أسود', 'أزرق', 'رمادي', 'أبيض'];
  const sizes = ['S', 'M', 'L', 'XL'];
  const products = [];

  for (let i = 1; i <= count; i++) {
    products.push({
      id: i,
      name: `${names[(i-1) % names.length]} - رقم ${i}`,
      description: descriptions[(i-1) % descriptions.length],
      price: Math.floor(Math.random() * (400 - 100 + 1)) + 100,
      imageUrl: images[(i-1) % images.length],
      colors: colors.slice(0, Math.floor(Math.random() * (colors.length - 1)) + 2),
      sizes: sizes.slice(0, Math.floor(Math.random() * (sizes.length - 1)) + 2),
    });
  }
  return products;
};

const PRODUCTS = generateDummyProducts(PRODUCT_COUNT);

// إنشاء سياق (Context) لمشاركة حالة التطبيق بين المكونات
const AppContext = createContext();

// مكون شاشة العرض الترويجية (Hero Section) مع الصور المتحركة
const HeroSection = () => {
  const [currentSlide, setCurrentSlide] = useState(0);
  const slides = [
    'https://images.unsplash.com/photo-1556905055-6b22b5e2825b?ixlib=rb-4.0.3&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=1080&fit=max',
    'https://images.unsplash.com/photo-1492707835100-36a512036c05?ixlib=rb-4.0.3&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=1080&fit=max',
    'https://images.unsplash.com/photo-1563299797-2510b6510476?ixlib=rb-4.0.3&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=1080&fit=max'
  ];

  useEffect(() => {
    const interval = setInterval(() => {
      setCurrentSlide((prev) => (prev + 1) % slides.length);
    }, 4000);
    return () => clearInterval(interval);
  }, [slides.length]);

  return (
    <section 
        className="relative overflow-hidden rounded-2xl mb-12 shadow-lg h-96"
    >
        <div 
            className="flex h-full w-full transition-all duration-1000 ease-in-out"
            style={{ transform: `translateX(-${currentSlide * 100}%)` }}
        >
            {slides.map((image, index) => (
                <div key={index} className="flex-shrink-0 w-full h-full bg-cover bg-center relative" style={{ backgroundImage: `url('${image}')` }}>
                    <div className="absolute inset-0 bg-slate-900 opacity-60"></div>
                </div>
            ))}
        </div>
        
        <div className="absolute inset-0 z-10 flex flex-col items-center justify-center text-white text-center p-6 md:p-12">
            <h1 className="text-3xl md:text-5xl font-extrabold leading-tight mb-4">أحدث العروض</h1>
            <p className="text-lg md:text-xl mb-6 max-w-lg">
                اكتشف مجموعتنا الجديدة واستفد من عروض خاصة وخصومات لا مثيل لها.
            </p>
            <button className="bg-white text-slate-900 font-bold py-3 px-8 rounded-full hover:bg-gray-200 transition-colors shadow-lg">
                تسوق الآن
            </button>
        </div>

        <div className="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex gap-2 z-20">
            {slides.map((_, index) => (
                <div 
                    key={index} 
                    className={`h-2 w-2 rounded-full transition-all duration-300 ${currentSlide === index ? 'bg-white scale-150' : 'bg-gray-400 opacity-50'}`}
                ></div>
            ))}
        </div>
    </section>
  );
};


// مكون بطاقة المنتج الفردي في الصفحة الرئيسية
const ProductCard = ({ product, onViewDetails }) => (
  <div className="bg-white rounded-2xl shadow-lg p-6 flex flex-col items-center text-center transform transition-all hover:scale-[1.02] hover:shadow-xl">
    <img src={product.imageUrl} alt={product.name} className="w-full h-48 object-cover rounded-xl mb-4" />
    <h3 className="text-lg font-bold text-gray-800 mb-1">{product.name}</h3>
    <p className="text-sm text-gray-600 mb-3">{product.description.substring(0, 50)}...</p>
    <div className="flex items-center justify-center mb-4">
      <span className="text-2xl font-extrabold text-gray-900">{product.price} ريال</span>
    </div>
    <button
      onClick={() => onViewDetails(product.id)}
      className="w-full bg-slate-900 text-white font-bold py-3 px-6 rounded-full hover:bg-slate-700 transition-colors shadow-md"
    >
      عرض التفاصيل
    </button>
  </div>
);

// مكون قائمة المنتجات الرئيسية
const ProductList = ({ onViewDetails, searchQuery }) => {
  const filteredProducts = PRODUCTS.filter(product =>
    product.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
    product.description.toLowerCase().includes(searchQuery.toLowerCase())
  );

  return (
    <div className="container mx-auto px-4 py-8">
      <h2 className="text-4xl font-extrabold text-gray-800 mb-10 text-center">منتجاتنا المميزة</h2>
      {filteredProducts.length > 0 ? (
        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
          {filteredProducts.map(product => (
            <ProductCard key={product.id} product={product} onViewDetails={onViewDetails} />
          ))}
        </div>
      ) : (
        <div className="text-center text-gray-500 text-lg py-12">
          <p>عذراً، لا يوجد منتجات مطابقة لعملية البحث.</p>
        </div>
      )}
    </div>
  );
};

// مكون لتقييمات المنتج
const ReviewsList = ({ productId }) => {
    const [reviews, setReviews] = useState([]);
    const { db, isAuthReady } = useContext(AppContext);
    
    useEffect(() => {
        if (!db || !isAuthReady) return;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const reviewsCollection = collection(db, `artifacts/${appId}/public/data/reviews`);
        const q = query(reviewsCollection, where('productId', '==', productId));

        const unsubscribe = onSnapshot(q, (snapshot) => {
            const reviewsData = snapshot.docs.map(doc => doc.data());
            setReviews(reviewsData);
        });

        return () => unsubscribe();
    }, [db, productId, isAuthReady]);

    return (
        <div className="mt-8">
            <h3 className="text-2xl font-bold text-gray-800 mb-4">آراء العملاء ({reviews.length})</h3>
            {reviews.length > 0 ? (
                <div className="space-y-6">
                    {reviews.map((review, index) => (
                        <div key={index} className="bg-gray-50 p-6 rounded-lg shadow-sm">
                            <div className="flex items-center gap-2 mb-2">
                                <User size={20} className="text-gray-500" />
                                <span className="font-semibold">{review.userEmail}</span>
                            </div>
                            <div className="flex items-center mb-2">
                                {Array(review.rating).fill(0).map((_, i) => (
                                    <span key={i} className="text-yellow-400">★</span>
                                ))}
                                {Array(5 - review.rating).fill(0).map((_, i) => (
                                    <span key={i} className="text-gray-300">★</span>
                                ))}
                            </div>
                            <p className="text-gray-700">{review.comment}</p>
                        </div>
                    ))}
                </div>
            ) : (
                <p className="text-gray-500">لا توجد تقييمات لهذا المنتج بعد.</p>
            )}
        </div>
    );
};

// مكون نموذج إضافة تقييم جديد
const ReviewForm = ({ productId }) => {
    const { authUser, db, isAuthReady } = useContext(AppContext);
    const [rating, setRating] = useState(0);
    const [comment, setComment] = useState('');
    const [message, setMessage] = useState('');

    const handleSubmit = async (e) => {
        e.preventDefault();
        if (!authUser || !db || !isAuthReady) {
            setMessage('الرجاء تسجيل الدخول لإضافة تقييم.');
            return;
        }
        if (!comment.trim() || rating === 0) {
            setMessage('الرجاء ملء حقل التعليق واختيار تقييم.');
            return;
        }
        
        try {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const reviewsCollection = collection(db, `artifacts/${appId}/public/data/reviews`);
            await addDoc(reviewsCollection, {
                productId: productId,
                userEmail: authUser.email,
                rating: rating,
                comment: comment,
                createdAt: serverTimestamp()
            });
            setMessage('تمت إضافة تقييمك بنجاح!');
            setRating(0);
            setComment('');
        } catch (error) {
            console.error("Error adding review: ", error);
            setMessage('فشل إضافة التقييم. حاول مرة أخرى.');
        }
        setTimeout(() => setMessage(''), 3000);
    };

    return (
        <div className="mt-8 bg-white p-6 rounded-lg shadow-lg">
            <h3 className="text-2xl font-bold text-gray-800 mb-4">أضف تقييمك</h3>
            {authUser ? (
                <form onSubmit={handleSubmit}>
                    <div className="mb-4">
                        <label className="block text-gray-700 font-semibold mb-2">تقييمك:</label>
                        <div className="flex">
                            {[1, 2, 3, 4, 5].map((star) => (
                                <span 
                                    key={star} 
                                    onClick={() => setRating(star)}
                                    className={`cursor-pointer text-3xl transition-colors ${rating >= star ? 'text-yellow-400' : 'text-gray-300'}`}
                                >
                                    ★
                                </span>
                            ))}
                        </div>
                    </div>
                    <div className="mb-4">
                        <label className="block text-gray-700 font-semibold mb-2" htmlFor="comment">تعليقك:</label>
                        <textarea
                            id="comment"
                            value={comment}
                            onChange={(e) => setComment(e.target.value)}
                            className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-900 transition-colors"
                            rows="4"
                            required
                        ></textarea>
                    </div>
                    <button type="submit" className="w-full bg-slate-900 text-white font-bold py-3 rounded-full hover:bg-slate-700 transition-colors shadow-lg">
                        إرسال التقييم
                    </button>
                    {message && <p className="text-sm mt-4 text-center text-green-600">{message}</p>}
                </form>
            ) : (
                <p className="text-center text-gray-500">
                    الرجاء <button onClick={() => window.location.reload()} className="text-slate-900 font-bold hover:underline">تسجيل الدخول</button> لإضافة تقييم.
                </p>
            )}
        </div>
    );
};

// مكون صفحة تفاصيل المنتج الواحد
const ProductDetail = ({ productId, onGoBack }) => {
  const { addToCart, addToFavorites, removeFromFavorites, authUser, favorites } = useContext(AppContext);
  const product = PRODUCTS.find(p => p.id === productId);
  const [selectedSize, setSelectedSize] = useState(product?.sizes[0] || null);
  const [selectedColor, setSelectedColor] = useState(product?.colors[0] || null);
  const [message, setMessage] = useState('');

  const isFavorite = favorites.some(fav => fav.id === product.id);

  if (!product) {
    return (
      <div className="container mx-auto px-4 py-8 text-center text-gray-500">
        <h2 className="text-2xl font-bold">المنتج غير موجود</h2>
        <button onClick={onGoBack} className="mt-4 text-slate-800 font-bold hover:underline">العودة للمتجر</button>
      </div>
    );
  }

  const handleAddToCart = async () => {
    if (!authUser) {
        setMessage('الرجاء تسجيل الدخول لإضافة منتجات إلى السلة.');
        return;
    }
    
    if (product.sizes.length > 0 && !selectedSize) {
        setMessage('الرجاء اختيار الحجم.');
        return;
    }
    if (product.colors.length > 0 && !selectedColor) {
        setMessage('الرجاء اختيار اللون.');
        return;
    }

    try {
        await addToCart({ ...product, selectedSize, selectedColor });
        setMessage('تمت إضافة المنتج إلى السلة!');
        setTimeout(() => setMessage(''), 2000);
    } catch (error) {
        setMessage('فشل إضافة المنتج. حاول مرة أخرى.');
    }
  };

  const handleFavoriteClick = async () => {
    if (!authUser) {
        setMessage('الرجاء تسجيل الدخول لإضافة منتجات إلى المفضلة.');
        return;
    }
    if (isFavorite) {
        await removeFromFavorites(product.id);
        setMessage('تمت إزالة المنتج من المفضلة.');
    } else {
        await addToFavorites(product);
        setMessage('تمت إضافة المنتج إلى المفضلة.');
    }
    setTimeout(() => setMessage(''), 2000);
  };

  return (
    <div className="container mx-auto px-4 py-8">
      <button onClick={onGoBack} className="flex items-center text-gray-600 hover:text-gray-800 transition-colors mb-6">
        <ChevronLeft size={20} className="ml-2" />
        العودة للمتجر
      </button>

      <div className="bg-white rounded-2xl shadow-xl p-8 flex flex-col lg:flex-row gap-8">
        <div className="lg:w-1/2">
          <img src={product.imageUrl} alt={product.name} className="w-full h-auto rounded-xl shadow-lg" />
        </div>
        <div className="lg:w-1/2">
          <h1 className="text-3xl md:text-4xl font-extrabold text-gray-900 mb-4">{product.name}</h1>
          <p className="text-2xl font-bold text-gray-900 mb-6">{product.price} ريال</p>
          <p className="text-gray-600 mb-8 leading-relaxed text-lg">{product.description}</p>
          
          {/* خيارات الحجم واللون */}
          <div className="mb-8">
            {product.sizes && product.sizes.length > 0 && (
              <div className="mb-6">
                <h4 className="font-bold text-gray-800 mb-2">الحجم:</h4>
                <div className="flex gap-2">
                  {product.sizes.map(size => (
                    <button
                      key={size}
                      onClick={() => setSelectedSize(size)}
                      className={`px-4 py-2 border rounded-full text-sm font-semibold transition-colors
                        ${selectedSize === size ? 'bg-slate-900 text-white border-slate-900' : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-100'}
                      `}
                    >
                      {size}
                    </button>
                  ))}
                </div>
              </div>
            )}
            {product.colors && product.colors.length > 0 && (
              <div>
                <h4 className="font-bold text-gray-800 mb-2">اللون:</h4>
                <div className="flex gap-2">
                  {product.colors.map(color => (
                    <button
                      key={color}
                      onClick={() => setSelectedColor(color)}
                      className={`px-4 py-2 border rounded-full text-sm font-semibold transition-colors
                        ${selectedColor === color ? 'bg-slate-900 text-white border-slate-900' : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-100'}
                      `}
                    >
                      {color}
                    </button>
                  ))}
                </div>
              </div>
            )}
          </div>

          <div className="flex items-center gap-4">
            <button
              onClick={handleAddToCart}
              className="flex-grow bg-slate-900 text-white font-bold py-4 px-8 rounded-full hover:bg-slate-700 transition-colors shadow-lg"
            >
              <ShoppingCart size={20} className="inline-block ml-2" />
              أضف إلى السلة
            </button>
            <button
              onClick={handleFavoriteClick}
              className={`p-4 rounded-full transition-colors ${isFavorite ? 'bg-red-500 text-white hover:bg-red-600' : 'bg-gray-200 text-gray-600 hover:bg-gray-300'}`}
            >
              <Heart size={24} />
            </button>
          </div>
          {message && (
            <div className="mt-4 text-center text-sm font-bold text-green-600">
              {message}
            </div>
          )}
        </div>
      </div>
      <ReviewsList productId={productId} />
      <ReviewForm productId={productId} />
    </div>
  );
};

// مكون صفحة عربة التسوق
const ShoppingCartPage = ({ onGoBack, onGoToCheckout }) => {
  const { cart, removeFromCart, authUser } = useContext(AppContext);
  const total = cart.reduce((sum, item) => sum + item.price, 0);

  return (
    <div className="container mx-auto px-4 py-8">
      <button onClick={onGoBack} className="flex items-center text-gray-600 hover:text-gray-800 transition-colors mb-6">
        <ChevronLeft size={20} className="ml-2" />
        العودة للمتجر
      </button>
      <h1 className="text-3xl font-extrabold text-gray-800 mb-8 text-center">عربة التسوق</h1>

      {cart.length === 0 ? (
        <div className="text-center text-gray-500 text-lg py-12 bg-white rounded-2xl shadow-md">
          <p>عربة التسوق فارغة.</p>
        </div>
      ) : (
        <div className="bg-white rounded-2xl shadow-xl p-8">
          <div className="space-y-6">
            {cart.map((item, index) => (
              <div key={index} className="flex items-center gap-6 border-b border-gray-200 pb-6 last:border-b-0 last:pb-0">
                <img src={item.imageUrl} alt={item.name} className="w-24 h-24 object-cover rounded-md" />
                <div className="flex-grow">
                  <h4 className="font-bold text-lg text-gray-800">{item.name}</h4>
                  <p className="text-gray-600 text-sm">{item.description.substring(0, 50)}...</p>
                  {item.selectedSize && <p className="text-sm font-semibold text-gray-500 mt-1">الحجم: {item.selectedSize}</p>}
                  {item.selectedColor && <p className="text-sm font-semibold text-gray-500">اللون: {item.selectedColor}</p>}
                  <p className="text-xl font-bold text-gray-900 mt-2">{item.price} ريال</p>
                </div>
                <button
                  onClick={() => removeFromCart(index)}
                  className="p-3 text-red-500 hover:text-red-700 transition-colors"
                >
                  <Trash2 size={24} />
                </button>
              </div>
            ))}
          </div>

          <div className="border-t border-gray-200 mt-8 pt-6">
            <div className="flex justify-between items-center text-2xl font-bold text-gray-800 mb-4">
              <span>الإجمالي:</span>
              <span>{total} ريال</span>
            </div>
            {authUser ? (
                <button onClick={onGoToCheckout} className="w-full bg-slate-900 text-white font-bold py-4 rounded-full hover:bg-slate-700 transition-colors shadow-lg">
                    <span className="inline-block ml-2">الدفع الآن</span>
                    <ShoppingCart size={20} className="inline-block" />
                </button>
            ) : (
                <p className="text-center text-gray-500">
                    الرجاء <button onClick={() => onGoToCheckout()} className="text-slate-900 font-bold hover:underline">تسجيل الدخول</button> للمتابعة إلى الدفع.
                </p>
            )}
          </div>
        </div>
      )}
    </div>
  );
};

// مكون صفحة الدفع (محاكاة)
const CheckoutPage = ({ onGoBack, onCheckoutSuccess }) => {
    const { cart, addOrder, authUser } = useContext(AppContext);
    const total = cart.reduce((sum, item) => sum + item.price, 0);
    const [isLoading, setIsLoading] = useState(false);
    const [message, setMessage] = useState('');

    const handlePayment = async () => {
        setIsLoading(true);
        setMessage('');

        // Simulate a payment delay
        setTimeout(async () => {
            try {
                const orderId = await addOrder(cart, total);
                setMessage(`تم الدفع بنجاح! رقم طلبك هو: ${orderId}`);
                onCheckoutSuccess();
            } catch (error) {
                setMessage('فشل عملية الدفع. يرجى المحاولة مرة أخرى.');
                console.error("Payment failed: ", error);
            } finally {
                setIsLoading(false);
            }
        }, 2000);
    };

    return (
        <div className="container mx-auto px-4 py-8">
            <button onClick={onGoBack} className="flex items-center text-gray-600 hover:text-gray-800 transition-colors mb-6">
                <ChevronLeft size={20} className="ml-2" />
                العودة للعربة
            </button>
            <h1 className="text-3xl font-extrabold text-gray-800 mb-8 text-center">إتمام الدفع</h1>

            <div className="bg-white rounded-2xl shadow-xl p-8">
                <h2 className="text-2xl font-bold text-gray-800 mb-4">ملخص الطلب</h2>
                <div className="space-y-4 border-b border-gray-200 pb-4">
                    {cart.map((item, index) => (
                        <div key={index} className="flex justify-between items-center">
                            <span className="text-gray-700">{item.name}</span>
                            <span className="font-semibold text-gray-900">{item.price} ريال</span>
                        </div>
                    ))}
                </div>
                <div className="flex justify-between items-center text-2xl font-bold text-gray-800 mt-4">
                    <span>الإجمالي:</span>
                    <span>{total} ريال</span>
                </div>
                
                <div className="mt-8 p-6 bg-gray-50 rounded-lg">
                    <h3 className="text-xl font-bold text-gray-800 mb-4">بيانات الدفع (محاكاة)</h3>
                    <div className="space-y-4">
                        <input type="text" placeholder="اسم حامل البطاقة" className="w-full p-3 border border-gray-300 rounded-lg" />
                        <input type="text" placeholder="رقم البطاقة" className="w-full p-3 border border-gray-300 rounded-lg" />
                        <div className="flex gap-4">
                            <input type="text" placeholder="تاريخ الانتهاء" className="w-1/2 p-3 border border-gray-300 rounded-lg" />
                            <input type="text" placeholder="رمز الأمان (CVV)" className="w-1/2 p-3 border border-gray-300 rounded-lg" />
                        </div>
                    </div>
                </div>

                <button
                    onClick={handlePayment}
                    className={`w-full text-white font-bold py-4 rounded-full mt-8 transition-colors shadow-lg ${isLoading ? 'bg-gray-400 cursor-not-allowed' : 'bg-slate-900 hover:bg-slate-700'}`}
                    disabled={isLoading}
                >
                    {isLoading ? 'جاري معالجة الدفع...' : 'تأكيد الدفع'}
                </button>
                {message && <p className="text-sm mt-4 text-center text-green-600">{message}</p>}
            </div>
        </div>
    );
};

// مكون صفحة الطلبات (سجل الطلبات)
const OrdersPage = ({ onGoBack }) => {
    const { orders } = useContext(AppContext);

    const getStatusColor = (status) => {
        switch (status) {
            case 'تم الدفع': return 'bg-green-500';
            case 'قيد التجهيز': return 'bg-yellow-500';
            case 'تم الشحن': return 'bg-blue-500';
            default: return 'bg-gray-500';
        }
    };

    return (
        <div className="container mx-auto px-4 py-8">
            <button onClick={onGoBack} className="flex items-center text-gray-600 hover:text-gray-800 transition-colors mb-6">
                <ChevronLeft size={20} className="ml-2" />
                العودة للمتجر
            </button>
            <h1 className="text-3xl font-extrabold text-gray-800 mb-8 text-center">طلباتي</h1>

            {orders.length === 0 ? (
                <div className="text-center text-gray-500 text-lg py-12 bg-white rounded-2xl shadow-md">
                    <p>لا يوجد لديك طلبات سابقة.</p>
                </div>
            ) : (
                <div className="space-y-8">
                    {orders.map((order, index) => (
                        <div key={index} className="bg-white rounded-2xl shadow-xl p-6">
                            <div className="flex justify-between items-center mb-4 border-b border-gray-200 pb-4">
                                <div>
                                    <h2 className="text-xl font-bold text-gray-800">طلب #<span className="font-mono">{order.id}</span></h2>
                                    <p className="text-sm text-gray-500">
                                        التاريخ: {order.createdAt?.toDate().toLocaleDateString('ar-SA')}
                                    </p>
                                </div>
                                <span className={`px-3 py-1 text-sm font-semibold text-white rounded-full ${getStatusColor(order.status)}`}>
                                    {order.status}
                                </span>
                            </div>
                            <div className="space-y-4">
                                {order.items.map((item, itemIndex) => (
                                    <div key={itemIndex} className="flex gap-4">
                                        <img src={item.imageUrl} alt={item.name} className="w-16 h-16 object-cover rounded-md" />
                                        <div>
                                            <h4 className="font-bold text-lg text-gray-800">{item.name}</h4>
                                            <p className="text-sm text-gray-600">{item.selectedSize}, {item.selectedColor}</p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                            <div className="border-t border-gray-200 mt-6 pt-4 text-right font-bold text-lg">
                                الإجمالي: {order.total} ريال
                            </div>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
};


// مكون صفحة المفضلة
const FavoritesPage = ({ onGoBack }) => {
  const { favorites, removeFromFavorites } = useContext(AppContext);

  return (
    <div className="container mx-auto px-4 py-8">
      <button onClick={onGoBack} className="flex items-center text-gray-600 hover:text-gray-800 transition-colors mb-6">
        <ChevronLeft size={20} className="ml-2" />
        العودة للمتجر
      </button>
      <h1 className="text-3xl font-extrabold text-gray-800 mb-8 text-center">المفضلة</h1>

      {favorites.length === 0 ? (
        <div className="text-center text-gray-500 text-lg py-12 bg-white rounded-2xl shadow-md">
          <p>قائمة المفضلة فارغة.</p>
        </div>
      ) : (
        <div className="bg-white rounded-2xl shadow-xl p-8">
          <div className="space-y-6">
            {favorites.map((item, index) => (
              <div key={item.id} className="flex items-center gap-6 border-b border-gray-200 pb-6 last:border-b-0 last:pb-0">
                <img src={item.imageUrl} alt={item.name} className="w-24 h-24 object-cover rounded-md" />
                <div className="flex-grow">
                  <h4 className="font-bold text-lg text-gray-800">{item.name}</h4>
                  <p className="text-gray-600 text-sm">{item.description.substring(0, 50)}...</p>
                  <p className="text-xl font-bold text-gray-900 mt-2">{item.price} ريال</p>
                </div>
                <button
                  onClick={() => removeFromFavorites(item.id)}
                  className="p-3 text-red-500 hover:text-red-700 transition-colors"
                >
                  <X size={24} />
                </button>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  );
};

// Login and Registration Forms
const AuthPage = ({ view, setView, onAuthSuccess }) => {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const { auth } = useContext(AppContext);

  const handleAction = async (e) => {
    e.preventDefault();
    setError('');
    try {
      if (view === 'login') {
        await signInWithEmailAndPassword(auth, email, password);
      } else {
        await createUserWithEmailAndPassword(auth, email, password);
      }
      onAuthSuccess();
    } catch (err) {
      setError(err.message);
    }
  };

  return (
    <div className="flex items-center justify-center min-h-screen bg-gray-100">
      <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md text-center">
        <h2 className="text-3xl font-extrabold text-gray-800 mb-6">
          {view === 'login' ? 'تسجيل الدخول' : 'إنشاء حساب'}
        </h2>
        <form onSubmit={handleAction} className="space-y-4">
          <input
            type="email"
            placeholder="البريد الإلكتروني"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            className="w-full p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-900 transition-colors"
            required
          />
          <input
            type="password"
            placeholder="كلمة المرور"
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            className="w-full p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-900 transition-colors"
            required
          />
          <button type="submit" className="w-full bg-slate-900 text-white font-bold py-4 rounded-full hover:bg-slate-700 transition-colors shadow-lg">
            {view === 'login' ? 'تسجيل الدخول' : 'إنشاء حساب'}
          </button>
        </form>
        {error && <p className="text-red-500 mt-4 text-sm">{error}</p>}
        <div className="mt-6 text-sm">
          {view === 'login' ? (
            <p>
              لا تمتلك حساب؟{' '}
              <button onClick={() => setView('register')} className="text-slate-800 hover:underline font-bold">
                أنشئ حساب الآن
              </button>
            </p>
          ) : (
            <p>
              لديك حساب بالفعل؟{' '}
              <button onClick={() => setView('login')} className="text-slate-800 hover:underline font-bold">
                تسجيل الدخول
              </button>
            </p>
          )}
        </div>
      </div>
    </div>
  );
};

// مكون صفحة الملف الشخصي
const ProfilePage = ({ onGoBack }) => {
    const { authUser } = useContext(AppContext);
    return (
        <div className="container mx-auto px-4 py-8">
            <button onClick={onGoBack} className="flex items-center text-gray-600 hover:text-gray-800 transition-colors mb-6">
                <ChevronLeft size={20} className="ml-2" />
                العودة للمتجر
            </button>
            <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md mx-auto text-center">
                <h1 className="text-3xl font-extrabold text-gray-800 mb-6">الملف الشخصي</h1>
                <p className="text-lg text-gray-600 mb-4">البريد الإلكتروني: <span className="font-semibold">{authUser.email}</span></p>
                <div className="mt-8 p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <h3 className="text-xl font-bold text-gray-800 mb-2">سجل الطلبات</h3>
                    <p className="text-gray-500">لا يوجد لديك طلبات سابقة.</p>
                </div>
            </div>
        </div>
    );
};

// مكون التطبيق الرئيسي
export default function App() {
  const [view, setView] = useState('home');
  const [selectedProductId, setSelectedProductId] = useState(null);
  const [cart, setCart] = useState([]);
  const [favorites, setFavorites] = useState([]);
  const [orders, setOrders] = useState([]);
  const [searchQuery, setSearchQuery] = useState('');
  const [app, setApp] = useState(null);
  const [auth, setAuth] = useState(null);
  const [db, setDb] = useState(null);
  const [authUser, setAuthUser] = useState(null);
  const [isAuthReady, setIsAuthReady] = useState(false);
  
  // Initialize Firebase and set up auth listener
  useEffect(() => {
    try {
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(__firebase_config);
        const firebaseApp = initializeApp(firebaseConfig);
        const firebaseAuth = getAuth(firebaseApp);
        const firestoreDb = getFirestore(firebaseApp);

        setApp(firebaseApp);
        setAuth(firebaseAuth);
        setDb(firestoreDb);

        const unsubscribe = onAuthStateChanged(firebaseAuth, async (user) => {
            if (user) {
                setAuthUser(user);
                // Listen for cart, favorites, and orders changes in Firestore
                const userCartRef = doc(firestoreDb, `artifacts/${appId}/users/${user.uid}/cart/items`);
                const cartUnsub = onSnapshot(userCartRef, (docSnap) => {
                    if (docSnap.exists()) {
                        setCart(docSnap.data().items || []);
                    } else {
                        setCart([]);
                    }
                });
                const userFavoritesRef = doc(firestoreDb, `artifacts/${appId}/users/${user.uid}/favorites/items`);
                const favUnsub = onSnapshot(userFavoritesRef, (docSnap) => {
                    if (docSnap.exists()) {
                        setFavorites(docSnap.data().items || []);
                    } else {
                        setFavorites([]);
                    }
                });
                const userOrdersRef = collection(firestoreDb, `artifacts/${appId}/users/${user.uid}/orders`);
                const ordersUnsub = onSnapshot(userOrdersRef, (snapshot) => {
                    const ordersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setOrders(ordersData);
                });
                return () => {
                    cartUnsub();
                    favUnsub();
                    ordersUnsub();
                };
            } else {
                setAuthUser(null);
                setCart([]);
                setFavorites([]);
                setOrders([]);
            }
            setIsAuthReady(true);
        });

        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        if (initialAuthToken) {
             signInWithCustomToken(firebaseAuth, initialAuthToken).catch(console.error);
        } else {
             signInAnonymously(firebaseAuth).catch(console.error);
        }

        return () => unsubscribe();
    } catch (error) {
      console.error("Firebase initialization failed:", error);
    }
  }, []);

  // Sync cart with Firestore
  useEffect(() => {
    const updateFirestoreCart = async () => {
        if (db && authUser) {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const userCartRef = doc(db, `artifacts/${appId}/users/${authUser.uid}/cart/items`);
                await setDoc(userCartRef, { items: cart });
            } catch (error) {
                console.error("Failed to update Firestore cart:", error);
            }
        }
    };
    if (isAuthReady) {
        updateFirestoreCart();
    }
  }, [cart, db, authUser, isAuthReady]);

  // Sync favorites with Firestore
  useEffect(() => {
    const updateFirestoreFavorites = async () => {
        if (db && authUser) {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const userFavoritesRef = doc(db, `artifacts/${appId}/users/${authUser.uid}/favorites/items`);
                await setDoc(userFavoritesRef, { items: favorites });
            } catch (error) {
                console.error("Failed to update Firestore favorites:", error);
            }
        }
    };
    if (isAuthReady) {
        updateFirestoreFavorites();
    }
  }, [favorites, db, authUser, isAuthReady]);

  // Function to add a product to the cart and Firestore
  const addToCart = async (product) => {
    const newCart = [...cart, product];
    setCart(newCart);
  };

  // Function to remove a product from the cart and Firestore
  const removeFromCart = async (index) => {
    const newCart = cart.filter((_, i) => i !== index);
    setCart(newCart);
  };

  // Function to add a product to favorites and Firestore
  const addToFavorites = async (product) => {
      const newFavorites = [...favorites, product];
      setFavorites(newFavorites);
  };
  
  // Function to remove a product from favorites and Firestore
  const removeFromFavorites = async (productId) => {
      const newFavorites = favorites.filter(fav => fav.id !== productId);
      setFavorites(newFavorites);
  };

  // Function to add an order to Firestore
  const addOrder = async (orderItems, total) => {
      if (!db || !authUser) {
          throw new Error("User not authenticated or database not ready.");
      }
      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
      const userOrdersCollection = collection(db, `artifacts/${appId}/users/${authUser.uid}/orders`);
      const newOrderRef = await addDoc(userOrdersCollection, {
          items: orderItems,
          total: total,
          status: 'تم الدفع', // Initial status
          createdAt: serverTimestamp()
      });
      return newOrderRef.id;
  };


  const handleLogout = async () => {
    if (auth) {
        try {
            await signOut(auth);
            setAuthUser(null);
            setView('home');
        } catch (error) {
            console.error("Logout failed:", error);
        }
    }
  };

  const handleViewDetails = (id) => {
    setSelectedProductId(id);
    setView('productDetail');
  };

  const handleGoToCart = () => {
    setView('cart');
  };
  
  const handleGoToFavorites = () => {
      if (authUser) {
          setView('favorites');
      } else {
          setView('login');
      }
  };
  
  const handleGoToProfile = () => {
      if (authUser) {
          setView('profile');
      } else {
          setView('login');
      }
  };
  
  const handleGoToOrders = () => {
      if (authUser) {
          setView('orders');
      } else {
          setView('login');
      }
  };

  const handleGoToCheckout = () => {
      if (authUser) {
          setView('checkout');
      } else {
          setView('login');
      }
  };
  
  const handleCheckoutSuccess = () => {
      setCart([]); // Clear cart after successful checkout
      setView('orders'); // Navigate to orders page
  };

  const handleGoBack = () => {
    if (view === 'productDetail' || view === 'checkout') {
      setView('home');
    } else if (view === 'cart' || view === 'favorites' || view === 'profile' || view === 'orders') {
      setView('home');
    }
  };
  
  if (!isAuthReady) {
    return (
        <div className="flex items-center justify-center min-h-screen bg-gray-100">
            <p className="text-xl text-gray-600">جارِ التحميل...</p>
        </div>
    );
  }

  const renderView = () => {
    if (view === 'login' || view === 'register') {
      return <AuthPage view={view} setView={setView} onAuthSuccess={() => setView('home')} />;
    }

    switch (view) {
      case 'home':
        return (
          <>
            <div className="container mx-auto px-4 py-8">
              <HeroSection />
              <ProductList onViewDetails={handleViewDetails} searchQuery={searchQuery} />
            </div>
          </>
        );
      case 'productDetail':
        return <ProductDetail productId={selectedProductId} onGoBack={handleGoBack} />;
      case 'cart':
        return <ShoppingCartPage onGoBack={handleGoBack} onGoToCheckout={handleGoToCheckout} />;
      case 'favorites':
        return <FavoritesPage onGoBack={handleGoBack} />;
      case 'profile':
        return <ProfilePage onGoBack={handleGoBack} />;
      case 'orders':
        return <OrdersPage onGoBack={handleGoBack} />;
      case 'checkout':
        return <CheckoutPage onGoBack={handleGoBack} onCheckoutSuccess={handleCheckoutSuccess} />;
      default:
        return <ProductList onViewDetails={handleViewDetails} searchQuery={searchQuery} />;
    }
  };

  return (
    <div className="font-sans bg-gray-100 text-right min-h-screen">
      <AppContext.Provider value={{ authUser, auth, db, cart, addToCart, removeFromCart, favorites, addToFavorites, removeFromFavorites, orders, addOrder, isAuthReady }}>
        <header className="bg-white shadow-md sticky top-0 z-50">
          <div className="container mx-auto px-4 py-4 flex justify-between items-center flex-wrap gap-4">
            <button onClick={() => { setView('home'); setSearchQuery(''); }} className="text-2xl font-bold text-gray-800 hover:text-gray-900 transition-colors flex items-center gap-2">
              <span className="text-3xl">👕</span>
              TOUIL.STOR
            </button>
            <div className="relative w-full md:w-1/2 order-2 md:order-1">
              <input
                type="text"
                placeholder="ابحث عن المنتجات..."
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                className="w-full pl-12 pr-4 py-2 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-slate-900 transition-colors"
              />
              <Search size={20} className="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400" />
            </div>
            <div className="flex items-center gap-4 order-1 md:order-2">
                {authUser ? (
                    <>
                        <button onClick={handleGoToProfile} className="p-2 text-gray-600 hover:text-gray-800 transition-colors flex items-center gap-2">
                            <span className="hidden sm:inline">حسابي</span>
                            <User size={24} />
                        </button>
                        <button onClick={handleGoToFavorites} className="p-2 text-gray-600 hover:text-gray-800 transition-colors flex items-center gap-2">
                            <span className="hidden sm:inline">المفضلة</span>
                            <Heart size={24} />
                        </button>
                        <button onClick={handleGoToOrders} className="p-2 text-gray-600 hover:text-gray-800 transition-colors flex items-center gap-2">
                            <span className="hidden sm:inline">طلباتي</span>
                            <Package size={24} />
                        </button>
                        <button onClick={handleLogout} className="p-2 text-gray-600 hover:text-gray-800 transition-colors flex items-center gap-2">
                            <span className="hidden sm:inline">تسجيل الخروج</span>
                            <LogOut size={24} />
                        </button>
                    </>
                ) : (
                    <>
                        <button onClick={() => setView('login')} className="p-2 text-gray-600 hover:text-gray-800 transition-colors flex items-center gap-2">
                            <span className="hidden sm:inline">تسجيل الدخول</span>
                            <LogIn size={24} />
                        </button>
                        <button onClick={() => setView('register')} className="p-2 text-gray-600 hover:text-gray-800 transition-colors flex items-center gap-2">
                            <span className="hidden sm:inline">إنشاء حساب</span>
                            <UserPlus size={24} />
                        </button>
                    </>
                )}
                <button onClick={handleGoToCart} className="relative p-2 text-gray-600 hover:text-gray-800 transition-colors">
                    <ShoppingCart size={24} />
                    <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">
                        {cart.length}
                    </span>
                </button>
            </div>
          </div>
        </header>
        <main>
          {renderView()}
        </main>
        <footer className="bg-gray-800 text-white py-8 mt-12">
          <div className="container mx-auto px-4 text-center">
            <p>&copy; 2024 TOUIL.STOR. جميع الحقوق محفوظة.</p>
          </div>
        </footer>
      </AppContext.Provider>
    </div>
  );
}
