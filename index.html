import React, { useState, createContext, useContext, useEffect } from 'react';
import { ShoppingCart, Heart, Search, ChevronLeft, Trash2, LogIn, LogOut, UserPlus, User, X, Package } from 'lucide-react';
import { initializeApp } from 'firebase/app';
import { getAuth, signInWithCustomToken, signInAnonymously, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut } from 'firebase/auth';
import { getFirestore, doc, setDoc, onSnapshot, collection, query, where, addDoc, serverTimestamp } from 'firebase/firestore';

// Ø«Ø§Ø¨Øª ÙŠÙ…ÙƒÙ†Ùƒ Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ù‡ Ù„Ø²ÙŠØ§Ø¯Ø© Ø£Ùˆ ØªÙ‚Ù„ÙŠÙ„ Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª ÙÙŠ Ø§Ù„Ù…ØªØ¬Ø±
const PRODUCT_COUNT = 40;

// Ø¯Ø§Ù„Ø© Ù„Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù†ØªØ¬Ø§Øª ÙˆÙ‡Ù…ÙŠØ© Ø¨Ø´ÙƒÙ„ ØªÙ„Ù‚Ø§Ø¦ÙŠ
const generateDummyProducts = (count) => {
  const names = ['ÙØ³ØªØ§Ù† Ø³Ù‡Ø±Ø© Ø£Ù†ÙŠÙ‚', 'Ù‚Ù…ÙŠØµ Ø±Ø¬Ø§Ù„ÙŠ Ù‚Ø·Ù†ÙŠ', 'Ø¬Ø§ÙƒÙŠØª Ø¬ÙŠÙ†Ø² Ø¹ØµØ±ÙŠ', 'ØªÙ†ÙˆØ±Ø© Ù…ÙŠØ¯ÙŠ ØµÙˆÙ'];
  const descriptions = [
    'Ù…Ù†ØªØ¬ Ø¹ØµØ±ÙŠ Ø¨ØªØµÙ…ÙŠÙ… Ø­Ø¯ÙŠØ«ØŒ Ù…Ø«Ø§Ù„ÙŠ Ù„Ù„Ù…Ù†Ø§Ø³Ø¨Ø§Øª Ø§Ù„Ø®Ø§ØµØ© ÙˆØ§Ù„Ø­ÙÙ„Ø§Øª. Ù…ØµÙ†ÙˆØ¹ Ù…Ù† Ù‚Ù…Ø§Ø´ ÙØ§Ø®Ø± Ù…Ø¹ ØªÙØ§ØµÙŠÙ„ Ø¯Ù‚ÙŠÙ‚Ø©.',
    'Ù…Ù†ØªØ¬ ÙƒÙ„Ø§Ø³ÙŠÙƒÙŠ Ù…ØµÙ†ÙˆØ¹ Ù…Ù† Ø§Ù„Ù‚Ø·Ù† Ø§Ù„Ù†Ø§Ø¹Ù…ØŒ ÙŠÙˆÙØ± Ø§Ù„Ø±Ø§Ø­Ø© ÙˆØ§Ù„Ø£Ù†Ø§Ù‚Ø© ÙÙŠ Ø¢Ù† ÙˆØ§Ø­Ø¯.',
    'Ù…Ù†ØªØ¬ Ø¨ØªØµÙ…ÙŠÙ… Ø¹ØµØ±ÙŠ ÙŠÙ†Ø§Ø³Ø¨ Ø§Ù„Ø¥Ø·Ù„Ø§Ù„Ø§Øª Ø§Ù„ÙŠÙˆÙ…ÙŠØ©. Ù…ØµÙ†ÙˆØ¹ Ù…Ù† Ø§Ù„Ø¯Ù†ÙŠÙ… Ø¹Ø§Ù„ÙŠ Ø§Ù„Ø¬ÙˆØ¯Ø© Ù„Ù…ØªØ§Ù†Ø© ØªØ¯ÙˆÙ… Ø·ÙˆÙŠÙ„Ø§Ù‹.',
    'Ù…Ù†ØªØ¬ Ø¯Ø§ÙØ¦ ÙˆÙ…Ø±ÙŠØ­ØŒ Ù…Ø«Ø§Ù„ÙŠ Ù„ÙØµÙ„ Ø§Ù„Ø´ØªØ§Ø¡. ÙŠÙ…ÙƒÙ† ØªÙ†Ø³ÙŠÙ‚Ù‡ Ø¨Ø³Ù‡ÙˆÙ„Ø© Ù…Ø¹ Ø§Ù„Ø¹Ø¯ÙŠØ¯ Ù…Ù† Ø§Ù„Ù‚Ø·Ø¹ Ø§Ù„Ø¹Ù„ÙˆÙŠØ©.'
  ];
  const images = [
    'https://images.unsplash.com/photo-1543265886-c43093c8d197?ixlib=rb-4.0.3&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=1080&fit=max',
    'https://images.unsplash.com/photo-1598460670355-0814407b1a03?ixlib=rb-4.0.3&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=1080&fit=max',
    'https://images.unsplash.com/photo-1591047120610-c117e3f815e1?ixlib=rb-4.0.3&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=1080&fit=max',
    'https://images.unsplash.com/photo-1631548694086-4e5b22b821a3?ixlib=rb-4.0.3&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=1080&fit=max'
  ];
  const colors = ['Ø£Ø³ÙˆØ¯', 'Ø£Ø²Ø±Ù‚', 'Ø±Ù…Ø§Ø¯ÙŠ', 'Ø£Ø¨ÙŠØ¶'];
  const sizes = ['S', 'M', 'L', 'XL'];
  const products = [];

  for (let i = 1; i <= count; i++) {
    products.push({
      id: i,
      name: `${names[(i-1) % names.length]} - Ø±Ù‚Ù… ${i}`,
      description: descriptions[(i-1) % descriptions.length],
      price: Math.floor(Math.random() * (400 - 100 + 1)) + 100,
      imageUrl: images[(i-1) % images.length],
      colors: colors.slice(0, Math.floor(Math.random() * (colors.length - 1)) + 2),
      sizes: sizes.slice(0, Math.floor(Math.random() * (sizes.length - 1)) + 2),
    });
  }
  return products;
};

const PRODUCTS = generateDummyProducts(PRODUCT_COUNT);

// Ø¥Ù†Ø´Ø§Ø¡ Ø³ÙŠØ§Ù‚ (Context) Ù„Ù…Ø´Ø§Ø±ÙƒØ© Ø­Ø§Ù„Ø© Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø¨ÙŠÙ† Ø§Ù„Ù…ÙƒÙˆÙ†Ø§Øª
const AppContext = createContext();

// Ù…ÙƒÙˆÙ† Ø´Ø§Ø´Ø© Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ØªØ±ÙˆÙŠØ¬ÙŠØ© (Hero Section) Ù…Ø¹ Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…ØªØ­Ø±ÙƒØ©
const HeroSection = () => {
  const [currentSlide, setCurrentSlide] = useState(0);
  const slides = [
    'https://images.unsplash.com/photo-1556905055-6b22b5e2825b?ixlib=rb-4.0.3&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=1080&fit=max',
    'https://images.unsplash.com/photo-1492707835100-36a512036c05?ixlib=rb-4.0.3&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=1080&fit=max',
    'https://images.unsplash.com/photo-1563299797-2510b6510476?ixlib=rb-4.0.3&q=80&fm=jpg&crop=entropy&cs=tinysrgb&w=1080&fit=max'
  ];

  useEffect(() => {
    const interval = setInterval(() => {
      setCurrentSlide((prev) => (prev + 1) % slides.length);
    }, 4000);
    return () => clearInterval(interval);
  }, [slides.length]);

  return (
    <section 
        className="relative overflow-hidden rounded-2xl mb-12 shadow-lg h-96"
    >
        <div 
            className="flex h-full w-full transition-all duration-1000 ease-in-out"
            style={{ transform: `translateX(-${currentSlide * 100}%)` }}
        >
            {slides.map((image, index) => (
                <div key={index} className="flex-shrink-0 w-full h-full bg-cover bg-center relative" style={{ backgroundImage: `url('${image}')` }}>
                    <div className="absolute inset-0 bg-slate-900 opacity-60"></div>
                </div>
            ))}
        </div>
        
        <div className="absolute inset-0 z-10 flex flex-col items-center justify-center text-white text-center p-6 md:p-12">
            <h1 className="text-3xl md:text-5xl font-extrabold leading-tight mb-4">Ø£Ø­Ø¯Ø« Ø§Ù„Ø¹Ø±ÙˆØ¶</h1>
            <p className="text-lg md:text-xl mb-6 max-w-lg">
                Ø§ÙƒØªØ´Ù Ù…Ø¬Ù…ÙˆØ¹ØªÙ†Ø§ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ÙˆØ§Ø³ØªÙØ¯ Ù…Ù† Ø¹Ø±ÙˆØ¶ Ø®Ø§ØµØ© ÙˆØ®ØµÙˆÙ…Ø§Øª Ù„Ø§ Ù…Ø«ÙŠÙ„ Ù„Ù‡Ø§.
            </p>
            <button className="bg-white text-slate-900 font-bold py-3 px-8 rounded-full hover:bg-gray-200 transition-colors shadow-lg">
                ØªØ³ÙˆÙ‚ Ø§Ù„Ø¢Ù†
            </button>
        </div>

        <div className="absolute bottom-4 left-1/2 transform -translate-x-1/2 flex gap-2 z-20">
            {slides.map((_, index) => (
                <div 
                    key={index} 
                    className={`h-2 w-2 rounded-full transition-all duration-300 ${currentSlide === index ? 'bg-white scale-150' : 'bg-gray-400 opacity-50'}`}
                ></div>
            ))}
        </div>
    </section>
  );
};


// Ù…ÙƒÙˆÙ† Ø¨Ø·Ø§Ù‚Ø© Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„ÙØ±Ø¯ÙŠ ÙÙŠ Ø§Ù„ØµÙØ­Ø© Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
const ProductCard = ({ product, onViewDetails }) => (
  <div className="bg-white rounded-2xl shadow-lg p-6 flex flex-col items-center text-center transform transition-all hover:scale-[1.02] hover:shadow-xl">
    <img src={product.imageUrl} alt={product.name} className="w-full h-48 object-cover rounded-xl mb-4" />
    <h3 className="text-lg font-bold text-gray-800 mb-1">{product.name}</h3>
    <p className="text-sm text-gray-600 mb-3">{product.description.substring(0, 50)}...</p>
    <div className="flex items-center justify-center mb-4">
      <span className="text-2xl font-extrabold text-gray-900">{product.price} Ø±ÙŠØ§Ù„</span>
    </div>
    <button
      onClick={() => onViewDetails(product.id)}
      className="w-full bg-slate-900 text-white font-bold py-3 px-6 rounded-full hover:bg-slate-700 transition-colors shadow-md"
    >
      Ø¹Ø±Ø¶ Ø§Ù„ØªÙØ§ØµÙŠÙ„
    </button>
  </div>
);

// Ù…ÙƒÙˆÙ† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠØ©
const ProductList = ({ onViewDetails, searchQuery }) => {
  const filteredProducts = PRODUCTS.filter(product =>
    product.name.toLowerCase().includes(searchQuery.toLowerCase()) ||
    product.description.toLowerCase().includes(searchQuery.toLowerCase())
  );

  return (
    <div className="container mx-auto px-4 py-8">
      <h2 className="text-4xl font-extrabold text-gray-800 mb-10 text-center">Ù…Ù†ØªØ¬Ø§ØªÙ†Ø§ Ø§Ù„Ù…Ù…ÙŠØ²Ø©</h2>
      {filteredProducts.length > 0 ? (
        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-8">
          {filteredProducts.map(product => (
            <ProductCard key={product.id} product={product} onViewDetails={onViewDetails} />
          ))}
        </div>
      ) : (
        <div className="text-center text-gray-500 text-lg py-12">
          <p>Ø¹Ø°Ø±Ø§Ù‹ØŒ Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù…Ù†ØªØ¬Ø§Øª Ù…Ø·Ø§Ø¨Ù‚Ø© Ù„Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¨Ø­Ø«.</p>
        </div>
      )}
    </div>
  );
};

// Ù…ÙƒÙˆÙ† Ù„ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬
const ReviewsList = ({ productId }) => {
    const [reviews, setReviews] = useState([]);
    const { db, isAuthReady } = useContext(AppContext);
    
    useEffect(() => {
        if (!db || !isAuthReady) return;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const reviewsCollection = collection(db, `artifacts/${appId}/public/data/reviews`);
        const q = query(reviewsCollection, where('productId', '==', productId));

        const unsubscribe = onSnapshot(q, (snapshot) => {
            const reviewsData = snapshot.docs.map(doc => doc.data());
            setReviews(reviewsData);
        });

        return () => unsubscribe();
    }, [db, productId, isAuthReady]);

    return (
        <div className="mt-8">
            <h3 className="text-2xl font-bold text-gray-800 mb-4">Ø¢Ø±Ø§Ø¡ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡ ({reviews.length})</h3>
            {reviews.length > 0 ? (
                <div className="space-y-6">
                    {reviews.map((review, index) => (
                        <div key={index} className="bg-gray-50 p-6 rounded-lg shadow-sm">
                            <div className="flex items-center gap-2 mb-2">
                                <User size={20} className="text-gray-500" />
                                <span className="font-semibold">{review.userEmail}</span>
                            </div>
                            <div className="flex items-center mb-2">
                                {Array(review.rating).fill(0).map((_, i) => (
                                    <span key={i} className="text-yellow-400">â˜…</span>
                                ))}
                                {Array(5 - review.rating).fill(0).map((_, i) => (
                                    <span key={i} className="text-gray-300">â˜…</span>
                                ))}
                            </div>
                            <p className="text-gray-700">{review.comment}</p>
                        </div>
                    ))}
                </div>
            ) : (
                <p className="text-gray-500">Ù„Ø§ ØªÙˆØ¬Ø¯ ØªÙ‚ÙŠÙŠÙ…Ø§Øª Ù„Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ø¹Ø¯.</p>
            )}
        </div>
    );
};

// Ù…ÙƒÙˆÙ† Ù†Ù…ÙˆØ°Ø¬ Ø¥Ø¶Ø§ÙØ© ØªÙ‚ÙŠÙŠÙ… Ø¬Ø¯ÙŠØ¯
const ReviewForm = ({ productId }) => {
    const { authUser, db, isAuthReady } = useContext(AppContext);
    const [rating, setRating] = useState(0);
    const [comment, setComment] = useState('');
    const [message, setMessage] = useState('');

    const handleSubmit = async (e) => {
        e.preventDefault();
        if (!authUser || !db || !isAuthReady) {
            setMessage('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¥Ø¶Ø§ÙØ© ØªÙ‚ÙŠÙŠÙ….');
            return;
        }
        if (!comment.trim() || rating === 0) {
            setMessage('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ù…Ù„Ø¡ Ø­Ù‚Ù„ Ø§Ù„ØªØ¹Ù„ÙŠÙ‚ ÙˆØ§Ø®ØªÙŠØ§Ø± ØªÙ‚ÙŠÙŠÙ….');
            return;
        }
        
        try {
            const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
            const reviewsCollection = collection(db, `artifacts/${appId}/public/data/reviews`);
            await addDoc(reviewsCollection, {
                productId: productId,
                userEmail: authUser.email,
                rating: rating,
                comment: comment,
                createdAt: serverTimestamp()
            });
            setMessage('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ØªÙ‚ÙŠÙŠÙ…Ùƒ Ø¨Ù†Ø¬Ø§Ø­!');
            setRating(0);
            setComment('');
        } catch (error) {
            console.error("Error adding review: ", error);
            setMessage('ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„ØªÙ‚ÙŠÙŠÙ…. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
        }
        setTimeout(() => setMessage(''), 3000);
    };

    return (
        <div className="mt-8 bg-white p-6 rounded-lg shadow-lg">
            <h3 className="text-2xl font-bold text-gray-800 mb-4">Ø£Ø¶Ù ØªÙ‚ÙŠÙŠÙ…Ùƒ</h3>
            {authUser ? (
                <form onSubmit={handleSubmit}>
                    <div className="mb-4">
                        <label className="block text-gray-700 font-semibold mb-2">ØªÙ‚ÙŠÙŠÙ…Ùƒ:</label>
                        <div className="flex">
                            {[1, 2, 3, 4, 5].map((star) => (
                                <span 
                                    key={star} 
                                    onClick={() => setRating(star)}
                                    className={`cursor-pointer text-3xl transition-colors ${rating >= star ? 'text-yellow-400' : 'text-gray-300'}`}
                                >
                                    â˜…
                                </span>
                            ))}
                        </div>
                    </div>
                    <div className="mb-4">
                        <label className="block text-gray-700 font-semibold mb-2" htmlFor="comment">ØªØ¹Ù„ÙŠÙ‚Ùƒ:</label>
                        <textarea
                            id="comment"
                            value={comment}
                            onChange={(e) => setComment(e.target.value)}
                            className="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-900 transition-colors"
                            rows="4"
                            required
                        ></textarea>
                    </div>
                    <button type="submit" className="w-full bg-slate-900 text-white font-bold py-3 rounded-full hover:bg-slate-700 transition-colors shadow-lg">
                        Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ‚ÙŠÙŠÙ…
                    </button>
                    {message && <p className="text-sm mt-4 text-center text-green-600">{message}</p>}
                </form>
            ) : (
                <p className="text-center text-gray-500">
                    Ø§Ù„Ø±Ø¬Ø§Ø¡ <button onClick={() => window.location.reload()} className="text-slate-900 font-bold hover:underline">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button> Ù„Ø¥Ø¶Ø§ÙØ© ØªÙ‚ÙŠÙŠÙ….
                </p>
            )}
        </div>
    );
};

// Ù…ÙƒÙˆÙ† ØµÙØ­Ø© ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ù…Ù†ØªØ¬ Ø§Ù„ÙˆØ§Ø­Ø¯
const ProductDetail = ({ productId, onGoBack }) => {
  const { addToCart, addToFavorites, removeFromFavorites, authUser, favorites } = useContext(AppContext);
  const product = PRODUCTS.find(p => p.id === productId);
  const [selectedSize, setSelectedSize] = useState(product?.sizes[0] || null);
  const [selectedColor, setSelectedColor] = useState(product?.colors[0] || null);
  const [message, setMessage] = useState('');

  const isFavorite = favorites.some(fav => fav.id === product.id);

  if (!product) {
    return (
      <div className="container mx-auto px-4 py-8 text-center text-gray-500">
        <h2 className="text-2xl font-bold">Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯</h2>
        <button onClick={onGoBack} className="mt-4 text-slate-800 font-bold hover:underline">Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ØªØ¬Ø±</button>
      </div>
    );
  }

  const handleAddToCart = async () => {
    if (!authUser) {
        setMessage('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©.');
        return;
    }
    
    if (product.sizes.length > 0 && !selectedSize) {
        setMessage('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø­Ø¬Ù….');
        return;
    }
    if (product.colors.length > 0 && !selectedColor) {
        setMessage('Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ù„ÙˆÙ†.');
        return;
    }

    try {
        await addToCart({ ...product, selectedSize, selectedColor });
        setMessage('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©!');
        setTimeout(() => setMessage(''), 2000);
    } catch (error) {
        setMessage('ÙØ´Ù„ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬. Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
    }
  };

  const handleFavoriteClick = async () => {
    if (!authUser) {
        setMessage('Ø§Ù„Ø±Ø¬Ø§Ø¡ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ù„Ø¥Ø¶Ø§ÙØ© Ù…Ù†ØªØ¬Ø§Øª Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙØ¶Ù„Ø©.');
        return;
    }
    if (isFavorite) {
        await removeFromFavorites(product.id);
        setMessage('ØªÙ…Øª Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ø§Ù„Ù…ÙØ¶Ù„Ø©.');
    } else {
        await addToFavorites(product);
        setMessage('ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¥Ù„Ù‰ Ø§Ù„Ù…ÙØ¶Ù„Ø©.');
    }
    setTimeout(() => setMessage(''), 2000);
  };

  return (
    <div className="container mx-auto px-4 py-8">
      <button onClick={onGoBack} className="flex items-center text-gray-600 hover:text-gray-800 transition-colors mb-6">
        <ChevronLeft size={20} className="ml-2" />
        Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ØªØ¬Ø±
      </button>

      <div className="bg-white rounded-2xl shadow-xl p-8 flex flex-col lg:flex-row gap-8">
        <div className="lg:w-1/2">
          <img src={product.imageUrl} alt={product.name} className="w-full h-auto rounded-xl shadow-lg" />
        </div>
        <div className="lg:w-1/2">
          <h1 className="text-3xl md:text-4xl font-extrabold text-gray-900 mb-4">{product.name}</h1>
          <p className="text-2xl font-bold text-gray-900 mb-6">{product.price} Ø±ÙŠØ§Ù„</p>
          <p className="text-gray-600 mb-8 leading-relaxed text-lg">{product.description}</p>
          
          {/* Ø®ÙŠØ§Ø±Ø§Øª Ø§Ù„Ø­Ø¬Ù… ÙˆØ§Ù„Ù„ÙˆÙ† */}
          <div className="mb-8">
            {product.sizes && product.sizes.length > 0 && (
              <div className="mb-6">
                <h4 className="font-bold text-gray-800 mb-2">Ø§Ù„Ø­Ø¬Ù…:</h4>
                <div className="flex gap-2">
                  {product.sizes.map(size => (
                    <button
                      key={size}
                      onClick={() => setSelectedSize(size)}
                      className={`px-4 py-2 border rounded-full text-sm font-semibold transition-colors
                        ${selectedSize === size ? 'bg-slate-900 text-white border-slate-900' : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-100'}
                      `}
                    >
                      {size}
                    </button>
                  ))}
                </div>
              </div>
            )}
            {product.colors && product.colors.length > 0 && (
              <div>
                <h4 className="font-bold text-gray-800 mb-2">Ø§Ù„Ù„ÙˆÙ†:</h4>
                <div className="flex gap-2">
                  {product.colors.map(color => (
                    <button
                      key={color}
                      onClick={() => setSelectedColor(color)}
                      className={`px-4 py-2 border rounded-full text-sm font-semibold transition-colors
                        ${selectedColor === color ? 'bg-slate-900 text-white border-slate-900' : 'bg-white text-gray-700 border-gray-300 hover:bg-gray-100'}
                      `}
                    >
                      {color}
                    </button>
                  ))}
                </div>
              </div>
            )}
          </div>

          <div className="flex items-center gap-4">
            <button
              onClick={handleAddToCart}
              className="flex-grow bg-slate-900 text-white font-bold py-4 px-8 rounded-full hover:bg-slate-700 transition-colors shadow-lg"
            >
              <ShoppingCart size={20} className="inline-block ml-2" />
              Ø£Ø¶Ù Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©
            </button>
            <button
              onClick={handleFavoriteClick}
              className={`p-4 rounded-full transition-colors ${isFavorite ? 'bg-red-500 text-white hover:bg-red-600' : 'bg-gray-200 text-gray-600 hover:bg-gray-300'}`}
            >
              <Heart size={24} />
            </button>
          </div>
          {message && (
            <div className="mt-4 text-center text-sm font-bold text-green-600">
              {message}
            </div>
          )}
        </div>
      </div>
      <ReviewsList productId={productId} />
      <ReviewForm productId={productId} />
    </div>
  );
};

// Ù…ÙƒÙˆÙ† ØµÙØ­Ø© Ø¹Ø±Ø¨Ø© Ø§Ù„ØªØ³ÙˆÙ‚
const ShoppingCartPage = ({ onGoBack, onGoToCheckout }) => {
  const { cart, removeFromCart, authUser } = useContext(AppContext);
  const total = cart.reduce((sum, item) => sum + item.price, 0);

  return (
    <div className="container mx-auto px-4 py-8">
      <button onClick={onGoBack} className="flex items-center text-gray-600 hover:text-gray-800 transition-colors mb-6">
        <ChevronLeft size={20} className="ml-2" />
        Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ØªØ¬Ø±
      </button>
      <h1 className="text-3xl font-extrabold text-gray-800 mb-8 text-center">Ø¹Ø±Ø¨Ø© Ø§Ù„ØªØ³ÙˆÙ‚</h1>

      {cart.length === 0 ? (
        <div className="text-center text-gray-500 text-lg py-12 bg-white rounded-2xl shadow-md">
          <p>Ø¹Ø±Ø¨Ø© Ø§Ù„ØªØ³ÙˆÙ‚ ÙØ§Ø±ØºØ©.</p>
        </div>
      ) : (
        <div className="bg-white rounded-2xl shadow-xl p-8">
          <div className="space-y-6">
            {cart.map((item, index) => (
              <div key={index} className="flex items-center gap-6 border-b border-gray-200 pb-6 last:border-b-0 last:pb-0">
                <img src={item.imageUrl} alt={item.name} className="w-24 h-24 object-cover rounded-md" />
                <div className="flex-grow">
                  <h4 className="font-bold text-lg text-gray-800">{item.name}</h4>
                  <p className="text-gray-600 text-sm">{item.description.substring(0, 50)}...</p>
                  {item.selectedSize && <p className="text-sm font-semibold text-gray-500 mt-1">Ø§Ù„Ø­Ø¬Ù…: {item.selectedSize}</p>}
                  {item.selectedColor && <p className="text-sm font-semibold text-gray-500">Ø§Ù„Ù„ÙˆÙ†: {item.selectedColor}</p>}
                  <p className="text-xl font-bold text-gray-900 mt-2">{item.price} Ø±ÙŠØ§Ù„</p>
                </div>
                <button
                  onClick={() => removeFromCart(index)}
                  className="p-3 text-red-500 hover:text-red-700 transition-colors"
                >
                  <Trash2 size={24} />
                </button>
              </div>
            ))}
          </div>

          <div className="border-t border-gray-200 mt-8 pt-6">
            <div className="flex justify-between items-center text-2xl font-bold text-gray-800 mb-4">
              <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span>
              <span>{total} Ø±ÙŠØ§Ù„</span>
            </div>
            {authUser ? (
                <button onClick={onGoToCheckout} className="w-full bg-slate-900 text-white font-bold py-4 rounded-full hover:bg-slate-700 transition-colors shadow-lg">
                    <span className="inline-block ml-2">Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø¢Ù†</span>
                    <ShoppingCart size={20} className="inline-block" />
                </button>
            ) : (
                <p className="text-center text-gray-500">
                    Ø§Ù„Ø±Ø¬Ø§Ø¡ <button onClick={() => onGoToCheckout()} className="text-slate-900 font-bold hover:underline">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</button> Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø¯ÙØ¹.
                </p>
            )}
          </div>
        </div>
      )}
    </div>
  );
};

// Ù…ÙƒÙˆÙ† ØµÙØ­Ø© Ø§Ù„Ø¯ÙØ¹ (Ù…Ø­Ø§ÙƒØ§Ø©)
const CheckoutPage = ({ onGoBack, onCheckoutSuccess }) => {
    const { cart, addOrder, authUser } = useContext(AppContext);
    const total = cart.reduce((sum, item) => sum + item.price, 0);
    const [isLoading, setIsLoading] = useState(false);
    const [message, setMessage] = useState('');

    const handlePayment = async () => {
        setIsLoading(true);
        setMessage('');

        // Simulate a payment delay
        setTimeout(async () => {
            try {
                const orderId = await addOrder(cart, total);
                setMessage(`ØªÙ… Ø§Ù„Ø¯ÙØ¹ Ø¨Ù†Ø¬Ø§Ø­! Ø±Ù‚Ù… Ø·Ù„Ø¨Ùƒ Ù‡Ùˆ: ${orderId}`);
                onCheckoutSuccess();
            } catch (error) {
                setMessage('ÙØ´Ù„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„Ø¯ÙØ¹. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰.');
                console.error("Payment failed: ", error);
            } finally {
                setIsLoading(false);
            }
        }, 2000);
    };

    return (
        <div className="container mx-auto px-4 py-8">
            <button onClick={onGoBack} className="flex items-center text-gray-600 hover:text-gray-800 transition-colors mb-6">
                <ChevronLeft size={20} className="ml-2" />
                Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ø¹Ø±Ø¨Ø©
            </button>
            <h1 className="text-3xl font-extrabold text-gray-800 mb-8 text-center">Ø¥ØªÙ…Ø§Ù… Ø§Ù„Ø¯ÙØ¹</h1>

            <div className="bg-white rounded-2xl shadow-xl p-8">
                <h2 className="text-2xl font-bold text-gray-800 mb-4">Ù…Ù„Ø®Øµ Ø§Ù„Ø·Ù„Ø¨</h2>
                <div className="space-y-4 border-b border-gray-200 pb-4">
                    {cart.map((item, index) => (
                        <div key={index} className="flex justify-between items-center">
                            <span className="text-gray-700">{item.name}</span>
                            <span className="font-semibold text-gray-900">{item.price} Ø±ÙŠØ§Ù„</span>
                        </div>
                    ))}
                </div>
                <div className="flex justify-between items-center text-2xl font-bold text-gray-800 mt-4">
                    <span>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</span>
                    <span>{total} Ø±ÙŠØ§Ù„</span>
                </div>
                
                <div className="mt-8 p-6 bg-gray-50 rounded-lg">
                    <h3 className="text-xl font-bold text-gray-800 mb-4">Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¯ÙØ¹ (Ù…Ø­Ø§ÙƒØ§Ø©)</h3>
                    <div className="space-y-4">
                        <input type="text" placeholder="Ø§Ø³Ù… Ø­Ø§Ù…Ù„ Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©" className="w-full p-3 border border-gray-300 rounded-lg" />
                        <input type="text" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø©" className="w-full p-3 border border-gray-300 rounded-lg" />
                        <div className="flex gap-4">
                            <input type="text" placeholder="ØªØ§Ø±ÙŠØ® Ø§Ù„Ø§Ù†ØªÙ‡Ø§Ø¡" className="w-1/2 p-3 border border-gray-300 rounded-lg" />
                            <input type="text" placeholder="Ø±Ù…Ø² Ø§Ù„Ø£Ù…Ø§Ù† (CVV)" className="w-1/2 p-3 border border-gray-300 rounded-lg" />
                        </div>
                    </div>
                </div>

                <button
                    onClick={handlePayment}
                    className={`w-full text-white font-bold py-4 rounded-full mt-8 transition-colors shadow-lg ${isLoading ? 'bg-gray-400 cursor-not-allowed' : 'bg-slate-900 hover:bg-slate-700'}`}
                    disabled={isLoading}
                >
                    {isLoading ? 'Ø¬Ø§Ø±ÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¯ÙØ¹...' : 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø¯ÙØ¹'}
                </button>
                {message && <p className="text-sm mt-4 text-center text-green-600">{message}</p>}
            </div>
        </div>
    );
};

// Ù…ÙƒÙˆÙ† ØµÙØ­Ø© Ø§Ù„Ø·Ù„Ø¨Ø§Øª (Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª)
const OrdersPage = ({ onGoBack }) => {
    const { orders } = useContext(AppContext);

    const getStatusColor = (status) => {
        switch (status) {
            case 'ØªÙ… Ø§Ù„Ø¯ÙØ¹': return 'bg-green-500';
            case 'Ù‚ÙŠØ¯ Ø§Ù„ØªØ¬Ù‡ÙŠØ²': return 'bg-yellow-500';
            case 'ØªÙ… Ø§Ù„Ø´Ø­Ù†': return 'bg-blue-500';
            default: return 'bg-gray-500';
        }
    };

    return (
        <div className="container mx-auto px-4 py-8">
            <button onClick={onGoBack} className="flex items-center text-gray-600 hover:text-gray-800 transition-colors mb-6">
                <ChevronLeft size={20} className="ml-2" />
                Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ØªØ¬Ø±
            </button>
            <h1 className="text-3xl font-extrabold text-gray-800 mb-8 text-center">Ø·Ù„Ø¨Ø§ØªÙŠ</h1>

            {orders.length === 0 ? (
                <div className="text-center text-gray-500 text-lg py-12 bg-white rounded-2xl shadow-md">
                    <p>Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø¯ÙŠÙƒ Ø·Ù„Ø¨Ø§Øª Ø³Ø§Ø¨Ù‚Ø©.</p>
                </div>
            ) : (
                <div className="space-y-8">
                    {orders.map((order, index) => (
                        <div key={index} className="bg-white rounded-2xl shadow-xl p-6">
                            <div className="flex justify-between items-center mb-4 border-b border-gray-200 pb-4">
                                <div>
                                    <h2 className="text-xl font-bold text-gray-800">Ø·Ù„Ø¨ #<span className="font-mono">{order.id}</span></h2>
                                    <p className="text-sm text-gray-500">
                                        Ø§Ù„ØªØ§Ø±ÙŠØ®: {order.createdAt?.toDate().toLocaleDateString('ar-SA')}
                                    </p>
                                </div>
                                <span className={`px-3 py-1 text-sm font-semibold text-white rounded-full ${getStatusColor(order.status)}`}>
                                    {order.status}
                                </span>
                            </div>
                            <div className="space-y-4">
                                {order.items.map((item, itemIndex) => (
                                    <div key={itemIndex} className="flex gap-4">
                                        <img src={item.imageUrl} alt={item.name} className="w-16 h-16 object-cover rounded-md" />
                                        <div>
                                            <h4 className="font-bold text-lg text-gray-800">{item.name}</h4>
                                            <p className="text-sm text-gray-600">{item.selectedSize}, {item.selectedColor}</p>
                                        </div>
                                    </div>
                                ))}
                            </div>
                            <div className="border-t border-gray-200 mt-6 pt-4 text-right font-bold text-lg">
                                Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ: {order.total} Ø±ÙŠØ§Ù„
                            </div>
                        </div>
                    ))}
                </div>
            )}
        </div>
    );
};


// Ù…ÙƒÙˆÙ† ØµÙØ­Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø©
const FavoritesPage = ({ onGoBack }) => {
  const { favorites, removeFromFavorites } = useContext(AppContext);

  return (
    <div className="container mx-auto px-4 py-8">
      <button onClick={onGoBack} className="flex items-center text-gray-600 hover:text-gray-800 transition-colors mb-6">
        <ChevronLeft size={20} className="ml-2" />
        Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ØªØ¬Ø±
      </button>
      <h1 className="text-3xl font-extrabold text-gray-800 mb-8 text-center">Ø§Ù„Ù…ÙØ¶Ù„Ø©</h1>

      {favorites.length === 0 ? (
        <div className="text-center text-gray-500 text-lg py-12 bg-white rounded-2xl shadow-md">
          <p>Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ÙØ¶Ù„Ø© ÙØ§Ø±ØºØ©.</p>
        </div>
      ) : (
        <div className="bg-white rounded-2xl shadow-xl p-8">
          <div className="space-y-6">
            {favorites.map((item, index) => (
              <div key={item.id} className="flex items-center gap-6 border-b border-gray-200 pb-6 last:border-b-0 last:pb-0">
                <img src={item.imageUrl} alt={item.name} className="w-24 h-24 object-cover rounded-md" />
                <div className="flex-grow">
                  <h4 className="font-bold text-lg text-gray-800">{item.name}</h4>
                  <p className="text-gray-600 text-sm">{item.description.substring(0, 50)}...</p>
                  <p className="text-xl font-bold text-gray-900 mt-2">{item.price} Ø±ÙŠØ§Ù„</p>
                </div>
                <button
                  onClick={() => removeFromFavorites(item.id)}
                  className="p-3 text-red-500 hover:text-red-700 transition-colors"
                >
                  <X size={24} />
                </button>
              </div>
            ))}
          </div>
        </div>
      )}
    </div>
  );
};

// Login and Registration Forms
const AuthPage = ({ view, setView, onAuthSuccess }) => {
  const [email, setEmail] = useState('');
  const [password, setPassword] = useState('');
  const [error, setError] = useState('');
  const { auth } = useContext(AppContext);

  const handleAction = async (e) => {
    e.preventDefault();
    setError('');
    try {
      if (view === 'login') {
        await signInWithEmailAndPassword(auth, email, password);
      } else {
        await createUserWithEmailAndPassword(auth, email, password);
      }
      onAuthSuccess();
    } catch (err) {
      setError(err.message);
    }
  };

  return (
    <div className="flex items-center justify-center min-h-screen bg-gray-100">
      <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md text-center">
        <h2 className="text-3xl font-extrabold text-gray-800 mb-6">
          {view === 'login' ? 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„' : 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨'}
        </h2>
        <form onSubmit={handleAction} className="space-y-4">
          <input
            type="email"
            placeholder="Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ"
            value={email}
            onChange={(e) => setEmail(e.target.value)}
            className="w-full p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-900 transition-colors"
            required
          />
          <input
            type="password"
            placeholder="ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±"
            value={password}
            onChange={(e) => setPassword(e.target.value)}
            className="w-full p-4 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-slate-900 transition-colors"
            required
          />
          <button type="submit" className="w-full bg-slate-900 text-white font-bold py-4 rounded-full hover:bg-slate-700 transition-colors shadow-lg">
            {view === 'login' ? 'ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„' : 'Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨'}
          </button>
        </form>
        {error && <p className="text-red-500 mt-4 text-sm">{error}</p>}
        <div className="mt-6 text-sm">
          {view === 'login' ? (
            <p>
              Ù„Ø§ ØªÙ…ØªÙ„Ùƒ Ø­Ø³Ø§Ø¨ØŸ{' '}
              <button onClick={() => setView('register')} className="text-slate-800 hover:underline font-bold">
                Ø£Ù†Ø´Ø¦ Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¢Ù†
              </button>
            </p>
          ) : (
            <p>
              Ù„Ø¯ÙŠÙƒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù„ÙØ¹Ù„ØŸ{' '}
              <button onClick={() => setView('login')} className="text-slate-800 hover:underline font-bold">
                ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„
              </button>
            </p>
          )}
        </div>
      </div>
    </div>
  );
};

// Ù…ÙƒÙˆÙ† ØµÙØ­Ø© Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ
const ProfilePage = ({ onGoBack }) => {
    const { authUser } = useContext(AppContext);
    return (
        <div className="container mx-auto px-4 py-8">
            <button onClick={onGoBack} className="flex items-center text-gray-600 hover:text-gray-800 transition-colors mb-6">
                <ChevronLeft size={20} className="ml-2" />
                Ø§Ù„Ø¹ÙˆØ¯Ø© Ù„Ù„Ù…ØªØ¬Ø±
            </button>
            <div className="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md mx-auto text-center">
                <h1 className="text-3xl font-extrabold text-gray-800 mb-6">Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø´Ø®ØµÙŠ</h1>
                <p className="text-lg text-gray-600 mb-4">Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ: <span className="font-semibold">{authUser.email}</span></p>
                <div className="mt-8 p-4 bg-gray-50 rounded-lg border border-gray-200">
                    <h3 className="text-xl font-bold text-gray-800 mb-2">Ø³Ø¬Ù„ Ø§Ù„Ø·Ù„Ø¨Ø§Øª</h3>
                    <p className="text-gray-500">Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ù„Ø¯ÙŠÙƒ Ø·Ù„Ø¨Ø§Øª Ø³Ø§Ø¨Ù‚Ø©.</p>
                </div>
            </div>
        </div>
    );
};

// Ù…ÙƒÙˆÙ† Ø§Ù„ØªØ·Ø¨ÙŠÙ‚ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ
export default function App() {
  const [view, setView] = useState('home');
  const [selectedProductId, setSelectedProductId] = useState(null);
  const [cart, setCart] = useState([]);
  const [favorites, setFavorites] = useState([]);
  const [orders, setOrders] = useState([]);
  const [searchQuery, setSearchQuery] = useState('');
  const [app, setApp] = useState(null);
  const [auth, setAuth] = useState(null);
  const [db, setDb] = useState(null);
  const [authUser, setAuthUser] = useState(null);
  const [isAuthReady, setIsAuthReady] = useState(false);
  
  // Initialize Firebase and set up auth listener
  useEffect(() => {
    try {
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = JSON.parse(__firebase_config);
        const firebaseApp = initializeApp(firebaseConfig);
        const firebaseAuth = getAuth(firebaseApp);
        const firestoreDb = getFirestore(firebaseApp);

        setApp(firebaseApp);
        setAuth(firebaseAuth);
        setDb(firestoreDb);

        const unsubscribe = onAuthStateChanged(firebaseAuth, async (user) => {
            if (user) {
                setAuthUser(user);
                // Listen for cart, favorites, and orders changes in Firestore
                const userCartRef = doc(firestoreDb, `artifacts/${appId}/users/${user.uid}/cart/items`);
                const cartUnsub = onSnapshot(userCartRef, (docSnap) => {
                    if (docSnap.exists()) {
                        setCart(docSnap.data().items || []);
                    } else {
                        setCart([]);
                    }
                });
                const userFavoritesRef = doc(firestoreDb, `artifacts/${appId}/users/${user.uid}/favorites/items`);
                const favUnsub = onSnapshot(userFavoritesRef, (docSnap) => {
                    if (docSnap.exists()) {
                        setFavorites(docSnap.data().items || []);
                    } else {
                        setFavorites([]);
                    }
                });
                const userOrdersRef = collection(firestoreDb, `artifacts/${appId}/users/${user.uid}/orders`);
                const ordersUnsub = onSnapshot(userOrdersRef, (snapshot) => {
                    const ordersData = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                    setOrders(ordersData);
                });
                return () => {
                    cartUnsub();
                    favUnsub();
                    ordersUnsub();
                };
            } else {
                setAuthUser(null);
                setCart([]);
                setFavorites([]);
                setOrders([]);
            }
            setIsAuthReady(true);
        });

        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        if (initialAuthToken) {
             signInWithCustomToken(firebaseAuth, initialAuthToken).catch(console.error);
        } else {
             signInAnonymously(firebaseAuth).catch(console.error);
        }

        return () => unsubscribe();
    } catch (error) {
      console.error("Firebase initialization failed:", error);
    }
  }, []);

  // Sync cart with Firestore
  useEffect(() => {
    const updateFirestoreCart = async () => {
        if (db && authUser) {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const userCartRef = doc(db, `artifacts/${appId}/users/${authUser.uid}/cart/items`);
                await setDoc(userCartRef, { items: cart });
            } catch (error) {
                console.error("Failed to update Firestore cart:", error);
            }
        }
    };
    if (isAuthReady) {
        updateFirestoreCart();
    }
  }, [cart, db, authUser, isAuthReady]);

  // Sync favorites with Firestore
  useEffect(() => {
    const updateFirestoreFavorites = async () => {
        if (db && authUser) {
            try {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const userFavoritesRef = doc(db, `artifacts/${appId}/users/${authUser.uid}/favorites/items`);
                await setDoc(userFavoritesRef, { items: favorites });
            } catch (error) {
                console.error("Failed to update Firestore favorites:", error);
            }
        }
    };
    if (isAuthReady) {
        updateFirestoreFavorites();
    }
  }, [favorites, db, authUser, isAuthReady]);

  // Function to add a product to the cart and Firestore
  const addToCart = async (product) => {
    const newCart = [...cart, product];
    setCart(newCart);
  };

  // Function to remove a product from the cart and Firestore
  const removeFromCart = async (index) => {
    const newCart = cart.filter((_, i) => i !== index);
    setCart(newCart);
  };

  // Function to add a product to favorites and Firestore
  const addToFavorites = async (product) => {
      const newFavorites = [...favorites, product];
      setFavorites(newFavorites);
  };
  
  // Function to remove a product from favorites and Firestore
  const removeFromFavorites = async (productId) => {
      const newFavorites = favorites.filter(fav => fav.id !== productId);
      setFavorites(newFavorites);
  };

  // Function to add an order to Firestore
  const addOrder = async (orderItems, total) => {
      if (!db || !authUser) {
          throw new Error("User not authenticated or database not ready.");
      }
      const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
      const userOrdersCollection = collection(db, `artifacts/${appId}/users/${authUser.uid}/orders`);
      const newOrderRef = await addDoc(userOrdersCollection, {
          items: orderItems,
          total: total,
          status: 'ØªÙ… Ø§Ù„Ø¯ÙØ¹', // Initial status
          createdAt: serverTimestamp()
      });
      return newOrderRef.id;
  };


  const handleLogout = async () => {
    if (auth) {
        try {
            await signOut(auth);
            setAuthUser(null);
            setView('home');
        } catch (error) {
            console.error("Logout failed:", error);
        }
    }
  };

  const handleViewDetails = (id) => {
    setSelectedProductId(id);
    setView('productDetail');
  };

  const handleGoToCart = () => {
    setView('cart');
  };
  
  const handleGoToFavorites = () => {
      if (authUser) {
          setView('favorites');
      } else {
          setView('login');
      }
  };
  
  const handleGoToProfile = () => {
      if (authUser) {
          setView('profile');
      } else {
          setView('login');
      }
  };
  
  const handleGoToOrders = () => {
      if (authUser) {
          setView('orders');
      } else {
          setView('login');
      }
  };

  const handleGoToCheckout = () => {
      if (authUser) {
          setView('checkout');
      } else {
          setView('login');
      }
  };
  
  const handleCheckoutSuccess = () => {
      setCart([]); // Clear cart after successful checkout
      setView('orders'); // Navigate to orders page
  };

  const handleGoBack = () => {
    if (view === 'productDetail' || view === 'checkout') {
      setView('home');
    } else if (view === 'cart' || view === 'favorites' || view === 'profile' || view === 'orders') {
      setView('home');
    }
  };
  
  if (!isAuthReady) {
    return (
        <div className="flex items-center justify-center min-h-screen bg-gray-100">
            <p className="text-xl text-gray-600">Ø¬Ø§Ø±Ù Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
        </div>
    );
  }

  const renderView = () => {
    if (view === 'login' || view === 'register') {
      return <AuthPage view={view} setView={setView} onAuthSuccess={() => setView('home')} />;
    }

    switch (view) {
      case 'home':
        return (
          <>
            <div className="container mx-auto px-4 py-8">
              <HeroSection />
              <ProductList onViewDetails={handleViewDetails} searchQuery={searchQuery} />
            </div>
          </>
        );
      case 'productDetail':
        return <ProductDetail productId={selectedProductId} onGoBack={handleGoBack} />;
      case 'cart':
        return <ShoppingCartPage onGoBack={handleGoBack} onGoToCheckout={handleGoToCheckout} />;
      case 'favorites':
        return <FavoritesPage onGoBack={handleGoBack} />;
      case 'profile':
        return <ProfilePage onGoBack={handleGoBack} />;
      case 'orders':
        return <OrdersPage onGoBack={handleGoBack} />;
      case 'checkout':
        return <CheckoutPage onGoBack={handleGoBack} onCheckoutSuccess={handleCheckoutSuccess} />;
      default:
        return <ProductList onViewDetails={handleViewDetails} searchQuery={searchQuery} />;
    }
  };

  return (
    <div className="font-sans bg-gray-100 text-right min-h-screen">
      <AppContext.Provider value={{ authUser, auth, db, cart, addToCart, removeFromCart, favorites, addToFavorites, removeFromFavorites, orders, addOrder, isAuthReady }}>
        <header className="bg-white shadow-md sticky top-0 z-50">
          <div className="container mx-auto px-4 py-4 flex justify-between items-center flex-wrap gap-4">
            <button onClick={() => { setView('home'); setSearchQuery(''); }} className="text-2xl font-bold text-gray-800 hover:text-gray-900 transition-colors flex items-center gap-2">
              <span className="text-3xl">ğŸ‘•</span>
              TOUIL.STOR
            </button>
            <div className="relative w-full md:w-1/2 order-2 md:order-1">
              <input
                type="text"
                placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª..."
                value={searchQuery}
                onChange={(e) => setSearchQuery(e.target.value)}
                className="w-full pl-12 pr-4 py-2 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-slate-900 transition-colors"
              />
              <Search size={20} className="absolute right-4 top-1/2 -translate-y-1/2 text-gray-400" />
            </div>
            <div className="flex items-center gap-4 order-1 md:order-2">
                {authUser ? (
                    <>
                        <button onClick={handleGoToProfile} className="p-2 text-gray-600 hover:text-gray-800 transition-colors flex items-center gap-2">
                            <span className="hidden sm:inline">Ø­Ø³Ø§Ø¨ÙŠ</span>
                            <User size={24} />
                        </button>
                        <button onClick={handleGoToFavorites} className="p-2 text-gray-600 hover:text-gray-800 transition-colors flex items-center gap-2">
                            <span className="hidden sm:inline">Ø§Ù„Ù…ÙØ¶Ù„Ø©</span>
                            <Heart size={24} />
                        </button>
                        <button onClick={handleGoToOrders} className="p-2 text-gray-600 hover:text-gray-800 transition-colors flex items-center gap-2">
                            <span className="hidden sm:inline">Ø·Ù„Ø¨Ø§ØªÙŠ</span>
                            <Package size={24} />
                        </button>
                        <button onClick={handleLogout} className="p-2 text-gray-600 hover:text-gray-800 transition-colors flex items-center gap-2">
                            <span className="hidden sm:inline">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø®Ø±ÙˆØ¬</span>
                            <LogOut size={24} />
                        </button>
                    </>
                ) : (
                    <>
                        <button onClick={() => setView('login')} className="p-2 text-gray-600 hover:text-gray-800 transition-colors flex items-center gap-2">
                            <span className="hidden sm:inline">ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„</span>
                            <LogIn size={24} />
                        </button>
                        <button onClick={() => setView('register')} className="p-2 text-gray-600 hover:text-gray-800 transition-colors flex items-center gap-2">
                            <span className="hidden sm:inline">Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨</span>
                            <UserPlus size={24} />
                        </button>
                    </>
                )}
                <button onClick={handleGoToCart} className="relative p-2 text-gray-600 hover:text-gray-800 transition-colors">
                    <ShoppingCart size={24} />
                    <span className="absolute -top-1 -right-1 bg-red-500 text-white text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center">
                        {cart.length}
                    </span>
                </button>
            </div>
          </div>
        </header>
        <main>
          {renderView()}
        </main>
        <footer className="bg-gray-800 text-white py-8 mt-12">
          <div className="container mx-auto px-4 text-center">
            <p>&copy; 2024 TOUIL.STOR. Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø©.</p>
          </div>
        </footer>
      </AppContext.Provider>
    </div>
  );
}
